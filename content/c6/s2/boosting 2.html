

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Boosting &#8212; Machine Learning from Scratch</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous">
    <link href="../../../_static/css/index.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../_static/sphinx-book-theme.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-dropdown.css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/sphinx-book-theme.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script src="../../../_static/togglebutton.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/sphinx-book-theme.js"></script>
    <script >var togglebuttonSelector = '.toggle, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"TeX": {"Macros": {"sumN": "\\sum_{n = 1}^N", "sumn": "\\sum_{n}", "prodN": "\\prod_{n = 1}^N", "bx": "\\mathbf{x}", "by": "\\mathbf{y}", "bX": "\\mathbf{X}", "bY": "\\mathbf{Y}", "bT": "\\mathbf{T}", "bbeta": "\\boldsymbol{\\beta}", "btheta": "\\boldsymbol{\\hat{\\theta}}}", "bmu": "\\boldsymbol{\\mu}", "bSigma": "\\boldsymbol{\\Sigma}", "bbetahat": "\\boldsymbol{\\hat{\\beta}}", "bbR": "\\mathbb{R}", "iid": "\\overset{\\small{\\text{i.i.d.}}}{\\sim}}", "dadb": ["{\\frac{\\partial #1}{\\partial #2}}", 2], "testing": "\\TeX", "R": "\\mathbb{R}"}}, "tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <link rel="shortcut icon" href="../../../_static/logo.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Implementation" href="../code.html" />
    <link rel="prev" title="Random Forests" href="random_forests.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="docsearch:language" content="en">



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../../../index.html">
  
  <img src="../../../_static/logo.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">Machine Learning from Scratch</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <p class="caption">
 <span class="caption-text">
  Introduction
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../table_of_contents.html">
   Table of Contents
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../conventions_notation.html">
   Conventions and Notation
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  1. Ordinary Linear Regression
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../c1/concept.html">
   Concept
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../c1/construction.html">
   Construction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../c1/code.html">
   Implementation
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  2. Linear Regression Extensions
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../c2/concept.html">
   Concept
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../c2/construction.html">
   Construction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../c2/code.html">
   Implementation
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  3. Discriminative Classifiers (Logistic Regression)
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../c3/concept.html">
   Concept
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../c3/construction.html">
   Construction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../c3/code.html">
   Implementation
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  4. Generative Classifiers (Naive Bayes)
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../c4/concept.html">
   Concept
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../c4/construction.html">
   Construction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../c4/code.html">
   Implementation
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  5. Decision Trees
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../c5/concept.html">
   Concept
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../c5/construction.html">
   Construction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../c5/code.html">
   Implementation
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  6. Tree Ensemble Methods
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../concept.html">
   Concept
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="reference internal" href="../construction.html">
   Construction
  </a>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="bagging.html">
     Bagging
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="random_forests.html">
     Random Forests
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Boosting
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../code.html">
   Implementation
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  7. Neural Networks
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../c7/concept.html">
   Concept
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../c7/construction.html">
   Construction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../c7/code.html">
   Implementation
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Appendix
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../appendix/math.html">
   Math
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../appendix/probability.html">
   Probability
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../appendix/methods.html">
   Common Methods
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../appendix/data.html">
   Datasets
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../../_sources/content/c6/s2/boosting.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/dafriedman97/mlbook"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/dafriedman97/mlbook/issues/new?title=Issue%20on%20page%20%2Fcontent/c6/s2/boosting.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/dafriedman97/mlbook/edit/master/content/c6/s2/boosting.ipynb"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/dafriedman97/mlbook/master?urlpath=tree/content/c6/s2/boosting.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/dafriedman97/mlbook/blob/master/content/c6/s2/boosting.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../../../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#classification-with-adaboost">
   1. Classification with AdaBoost
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#regression-with-adaboost-r2">
   2. Regression with AdaBoost.R2
  </a>
 </li>
</ul>

        </nav>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="boosting">
<h1>Boosting<a class="headerlink" href="#boosting" title="Permalink to this headline">¶</a></h1>
<p>In this section, we will construct a boosting classifier with the <code class="docutils literal notranslate"><span class="pre">AdaBoost</span></code> algorithm and a boosting regressor with the <code class="docutils literal notranslate"><span class="pre">AdaBoost.R2</span></code> algorithm. These algorithms can use a variety of weak learners but we will use decision tree classifiers and regressors, constructed in <a class="reference internal" href="../../c5/concept.html"><span class="doc">Chapter 5</span></a>.</p>
<div class="cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Import decision trees</span>
<span class="kn">import</span> <span class="nn">import_ipynb</span>
<span class="kn">import</span> <span class="nn">classification_tree</span> <span class="k">as</span> <span class="nn">ct</span><span class="p">;</span>

<span class="c1">## Import numpy and visualization packages</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span> 
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">datasets</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="classification-with-adaboost">
<h2>1. Classification with AdaBoost<a class="headerlink" href="#classification-with-adaboost" title="Permalink to this headline">¶</a></h2>
<p>The following is a construction of the binary AdaBoost classifier introduced in the <a class="reference internal" href="../s1/boosting.html"><span class="doc">concept section</span></a>. Let’s again use the <a class="reference internal" href="../../appendix/data.html"><span class="doc">penguins</span></a> dataset from <code class="docutils literal notranslate"><span class="pre">seaborn</span></code>, but rather than predicting the penguin’s species (a multiclass problem), we’ll predict whether the species is <em>Adelie</em> (a binary problem). The data is loaded and split into train vs. test with the hidden code cell below.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Load data</span>
<span class="n">penguins</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;penguins&#39;</span><span class="p">)</span>
<span class="n">penguins</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">penguins</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">,</span> <span class="s1">&#39;island&#39;</span><span class="p">]))</span>
<span class="n">y</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">penguins</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Adelie&#39;</span><span class="p">)</span>
<span class="n">y</span><span class="p">[</span><span class="n">y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

<span class="c1">## Train-test split</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">test_frac</span> <span class="o">=</span> <span class="mf">0.25</span>
<span class="n">test_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="n">test_frac</span><span class="p">)</span>
<span class="n">test_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="n">test_size</span><span class="p">,</span> <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">test_idxs</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">test_idxs</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">test_idxs</span><span class="p">]</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">test_idxs</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Recall that AdaBoost fits <em>weighted</em> weak learners. Let’s start by defining the weighted loss functions introduced in the <a class="reference internal" href="../s1/boosting.html"><span class="doc">concept section</span></a>. The helper function <code class="docutils literal notranslate"><span class="pre">get_weighted_pmk()</span></code> calculates</p>
<div class="math notranslate nohighlight">
\[
\hat{p}_{mk} = \frac{\sumN w_n I(\bx_n \in \mathcal{N}_m)}{\sumN w_n}
\]</div>
<p>for each class <span class="math notranslate nohighlight">\(k\)</span>. The <code class="docutils literal notranslate"><span class="pre">gini_index()</span></code> and <code class="docutils literal notranslate"><span class="pre">cross_entropy()</span></code> functions then call this function and return the appropriate loss.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Loss Functions</span>
<span class="k">def</span> <span class="nf">get_weighted_pmk</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
    <span class="n">ks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">weighted_pmk</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">y</span> <span class="o">==</span> <span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ks</span><span class="p">]</span>      
    <span class="k">return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">weighted_pmk</span><span class="p">)</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">gini_index</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
    <span class="n">weighted_pmk</span> <span class="o">=</span> <span class="n">get_weighted_pmk</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">weighted_pmk</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">weighted_pmk</span><span class="p">)</span> <span class="p">)</span>

<span class="k">def</span> <span class="nf">cross_entropy</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
    <span class="n">weighted_pmk</span> <span class="o">=</span> <span class="n">get_weighted_pmk</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>    
    <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weighted_pmk</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">weighted_pmk</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">split_loss</span><span class="p">(</span><span class="n">child1</span><span class="p">,</span> <span class="n">child2</span><span class="p">,</span> <span class="n">weights1</span><span class="p">,</span> <span class="n">weights2</span><span class="p">,</span> <span class="n">loss</span> <span class="o">=</span> <span class="n">cross_entropy</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">child1</span><span class="p">)</span><span class="o">*</span><span class="n">loss</span><span class="p">(</span><span class="n">child1</span><span class="p">,</span> <span class="n">weights1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">child2</span><span class="p">)</span><span class="o">*</span><span class="n">loss</span><span class="p">(</span><span class="n">child2</span><span class="p">,</span> <span class="n">weights2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">child1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">child2</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>In order to incorporate observation weights, we have to make slight adjustments to the <code class="docutils literal notranslate"><span class="pre">DecisionTreeClassifier</span></code> class. In the class we <a class="reference internal" href="../../c5/s2/classification_tree.html"><span class="doc">previously constructed</span></a>, the data from parent nodes was split and funneled anonymously to one of two child nodes. This alone will not allow us to incorporate weights. Instead, we need to also track the ID of each observation so we can track its weight. This is done with the <code class="docutils literal notranslate"><span class="pre">DecisionTreeClassifier</span></code> class defined in the hidden cell below, which is mostly a reconstruction of the class defined in Chapter 5.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Helper Classes</span>
<span class="k">class</span> <span class="nc">Node</span><span class="p">:</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Xsub</span><span class="p">,</span> <span class="n">ysub</span><span class="p">,</span> <span class="n">observations</span><span class="p">,</span> <span class="n">ID</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">parent_ID</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">leaf</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Xsub</span> <span class="o">=</span> <span class="n">Xsub</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ysub</span> <span class="o">=</span> <span class="n">ysub</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observations</span> <span class="o">=</span> <span class="n">observations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ID</span> <span class="o">=</span> <span class="n">ID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ysub</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_ID</span> <span class="o">=</span> <span class="n">parent_ID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leaf</span> <span class="o">=</span> <span class="n">leaf</span>
        

<span class="k">class</span> <span class="nc">Splitter</span><span class="p">:</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_split</span> <span class="o">=</span> <span class="kc">True</span>
        
    <span class="k">def</span> <span class="nf">_replace_split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;quant&#39;</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">L_values</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L_values</span> <span class="o">=</span> <span class="n">L_values</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">no_split</span> <span class="o">=</span> <span class="kc">False</span>

        
<span class="c1">## Main Class</span>
<span class="k">class</span> <span class="nc">DecisionTreeClassifier</span><span class="p">:</span>
    
    <span class="c1">#############################</span>
    <span class="c1">######## 1. TRAINING ########</span>
    <span class="c1">#############################</span>
    
    <span class="c1">######### FIT ##########</span>
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">loss_func</span> <span class="o">=</span> <span class="n">cross_entropy</span><span class="p">,</span> <span class="n">max_depth</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">min_size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        
        <span class="c1">## Add data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">X</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">dtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[:,</span><span class="n">d</span><span class="p">]))</span><span class="o">.</span><span class="n">dtype</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;quant&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">float</span> <span class="ow">or</span> <span class="n">dtype</span> <span class="o">==</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;cat&#39;</span> <span class="k">for</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">dtypes</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span>
        
        <span class="c1">## Add model parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_func</span> <span class="o">=</span> <span class="n">loss_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">max_depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_size</span> <span class="o">=</span> <span class="n">min_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">C</span>
        
        <span class="c1">## Initialize nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_ID</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">initial_node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">Xsub</span> <span class="o">=</span> <span class="n">X</span><span class="p">,</span> <span class="n">ysub</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">observations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">),</span> <span class="n">ID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_ID</span><span class="p">,</span> <span class="n">parent_ID</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_ID</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Build</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build</span><span class="p">()</span>

    <span class="c1">###### BUILD TREE ######</span>
    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">eligible_buds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_dict</span> 
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">):</span>
            
            <span class="c1">## Find eligible nodes for layer iteration</span>
            <span class="n">eligible_buds</span> <span class="o">=</span> <span class="p">{</span><span class="n">ID</span><span class="p">:</span><span class="n">node</span> <span class="k">for</span> <span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> 
                                <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">leaf</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span>
                                <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_size</span><span class="p">)</span> <span class="o">&amp;</span> 
                                <span class="p">(</span><span class="o">~</span><span class="n">ct</span><span class="o">.</span><span class="n">all_rows_equal</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Xsub</span><span class="p">))</span> <span class="o">&amp;</span>
                                <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ysub</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)}</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eligible_buds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            
            <span class="c1">## split each eligible parent</span>
            <span class="k">for</span> <span class="n">ID</span><span class="p">,</span> <span class="n">bud</span> <span class="ow">in</span> <span class="n">eligible_buds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                
                <span class="c1">## Find split</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_find_split</span><span class="p">(</span><span class="n">bud</span><span class="p">)</span>
                
                <span class="c1">## Make split</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">no_split</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_make_split</span><span class="p">()</span>
                
    <span class="c1">###### FIND SPLIT ######</span>
    <span class="k">def</span> <span class="nf">_find_split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bud</span><span class="p">):</span>
        
        <span class="c1">## Instantiate splitter</span>
        <span class="n">splitter</span> <span class="o">=</span> <span class="n">Splitter</span><span class="p">()</span>
        <span class="n">splitter</span><span class="o">.</span><span class="n">bud_ID</span> <span class="o">=</span> <span class="n">bud</span><span class="o">.</span><span class="n">ID</span>
        
        <span class="c1">## For each (eligible) predictor...</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">eligible_predictors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eligible_predictors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="p">,</span> <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">eligible_predictors</span><span class="p">):</span>
            <span class="n">Xsub_d</span> <span class="o">=</span> <span class="n">bud</span><span class="o">.</span><span class="n">Xsub</span><span class="p">[:,</span><span class="n">d</span><span class="p">]</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">Xsub_d</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1">## For each value...</span>
            <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;quant&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">Xsub_d</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">L_condition</span> <span class="o">=</span> <span class="n">Xsub_d</span> <span class="o">&lt;=</span> <span class="n">t</span>
                    <span class="n">ysub_L</span> <span class="o">=</span> <span class="n">bud</span><span class="o">.</span><span class="n">ysub</span><span class="p">[</span><span class="n">L_condition</span><span class="p">]</span>
                    <span class="n">ysub_R</span> <span class="o">=</span> <span class="n">bud</span><span class="o">.</span><span class="n">ysub</span><span class="p">[</span><span class="o">~</span><span class="n">L_condition</span><span class="p">]</span>
                    <span class="n">weights_L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">bud</span><span class="o">.</span><span class="n">observations</span><span class="p">][</span><span class="n">L_condition</span><span class="p">]</span>
                    <span class="n">weights_R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">bud</span><span class="o">.</span><span class="n">observations</span><span class="p">][</span><span class="o">~</span><span class="n">L_condition</span><span class="p">]</span>
                    <span class="n">loss</span> <span class="o">=</span> <span class="n">split_loss</span><span class="p">(</span><span class="n">ysub_L</span><span class="p">,</span> <span class="n">ysub_R</span><span class="p">,</span>
                                      <span class="n">weights_L</span><span class="p">,</span> <span class="n">weights_R</span><span class="p">,</span>
                                      <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_func</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">loss</span> <span class="o">&lt;</span> <span class="n">splitter</span><span class="o">.</span><span class="n">loss</span><span class="p">:</span>
                        <span class="n">splitter</span><span class="o">.</span><span class="n">_replace_split</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="s1">&#39;quant&#39;</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">L_values</span> <span class="ow">in</span> <span class="n">ct</span><span class="o">.</span><span class="n">possible_splits</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">Xsub_d</span><span class="p">)):</span>
                    <span class="n">L_condition</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">Xsub_d</span><span class="p">,</span> <span class="n">L_values</span><span class="p">)</span>
                    <span class="n">ysub_L</span> <span class="o">=</span> <span class="n">bud</span><span class="o">.</span><span class="n">ysub</span><span class="p">[</span><span class="n">L_condition</span><span class="p">]</span>
                    <span class="n">ysub_R</span> <span class="o">=</span> <span class="n">bud</span><span class="o">.</span><span class="n">ysub</span><span class="p">[</span><span class="o">~</span><span class="n">L_condition</span><span class="p">]</span>
                    <span class="n">weights_L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">bud</span><span class="o">.</span><span class="n">observations</span><span class="p">][</span><span class="n">L_condition</span><span class="p">]</span>
                    <span class="n">weights_R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">bud</span><span class="o">.</span><span class="n">observations</span><span class="p">][</span><span class="o">~</span><span class="n">L_condition</span><span class="p">]</span>
                    <span class="n">loss</span> <span class="o">=</span> <span class="n">split_loss</span><span class="p">(</span><span class="n">ysub_L</span><span class="p">,</span> <span class="n">ysub_R</span><span class="p">,</span>
                                      <span class="n">weights_L</span><span class="p">,</span> <span class="n">weights_R</span><span class="p">,</span>
                                      <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_func</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">loss</span> <span class="o">&lt;</span> <span class="n">splitter</span><span class="o">.</span><span class="n">loss</span><span class="p">:</span> 
                        <span class="n">splitter</span><span class="o">.</span><span class="n">_replace_split</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">L_values</span> <span class="o">=</span> <span class="n">L_values</span><span class="p">)</span>
                        
        <span class="c1">## Save splitter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span> <span class="o">=</span> <span class="n">splitter</span>
    
    <span class="c1">###### MAKE SPLIT ######</span>
    <span class="k">def</span> <span class="nf">_make_split</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="c1">## Update parent node</span>
        <span class="n">parent_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">bud_ID</span><span class="p">]</span>
        <span class="n">parent_node</span><span class="o">.</span><span class="n">leaf</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">parent_node</span><span class="o">.</span><span class="n">child_L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_ID</span>
        <span class="n">parent_node</span><span class="o">.</span><span class="n">child_R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_ID</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">parent_node</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">d</span>
        <span class="n">parent_node</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">dtype</span>
        <span class="n">parent_node</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">t</span>        
        <span class="n">parent_node</span><span class="o">.</span><span class="n">L_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">L_values</span>
        
        <span class="c1">## Get X and y data for children</span>
        <span class="k">if</span> <span class="n">parent_node</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;quant&#39;</span><span class="p">:</span>
            <span class="n">L_condition</span> <span class="o">=</span> <span class="n">parent_node</span><span class="o">.</span><span class="n">Xsub</span><span class="p">[:,</span><span class="n">parent_node</span><span class="o">.</span><span class="n">d</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">parent_node</span><span class="o">.</span><span class="n">t</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">L_condition</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">parent_node</span><span class="o">.</span><span class="n">Xsub</span><span class="p">[:,</span><span class="n">parent_node</span><span class="o">.</span><span class="n">d</span><span class="p">],</span> <span class="n">parent_node</span><span class="o">.</span><span class="n">L_values</span><span class="p">)</span>
        <span class="n">Xchild_L</span> <span class="o">=</span> <span class="n">parent_node</span><span class="o">.</span><span class="n">Xsub</span><span class="p">[</span><span class="n">L_condition</span><span class="p">]</span>
        <span class="n">ychild_L</span> <span class="o">=</span> <span class="n">parent_node</span><span class="o">.</span><span class="n">ysub</span><span class="p">[</span><span class="n">L_condition</span><span class="p">]</span>
        <span class="n">child_observations_L</span> <span class="o">=</span> <span class="n">parent_node</span><span class="o">.</span><span class="n">observations</span><span class="p">[</span><span class="n">L_condition</span><span class="p">]</span>
        <span class="n">Xchild_R</span> <span class="o">=</span> <span class="n">parent_node</span><span class="o">.</span><span class="n">Xsub</span><span class="p">[</span><span class="o">~</span><span class="n">L_condition</span><span class="p">]</span>
        <span class="n">ychild_R</span> <span class="o">=</span> <span class="n">parent_node</span><span class="o">.</span><span class="n">ysub</span><span class="p">[</span><span class="o">~</span><span class="n">L_condition</span><span class="p">]</span>
        <span class="n">child_observations_R</span> <span class="o">=</span> <span class="n">parent_node</span><span class="o">.</span><span class="n">observations</span><span class="p">[</span><span class="o">~</span><span class="n">L_condition</span><span class="p">]</span>
        
        <span class="c1">## Create child nodes</span>
        <span class="n">child_node_L</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">Xchild_L</span><span class="p">,</span> <span class="n">ychild_L</span><span class="p">,</span> <span class="n">child_observations_L</span><span class="p">,</span>
                            <span class="n">ID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_ID</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">parent_node</span><span class="o">.</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">parent_ID</span> <span class="o">=</span> <span class="n">parent_node</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
        <span class="n">child_node_R</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">Xchild_R</span><span class="p">,</span> <span class="n">ychild_R</span><span class="p">,</span> <span class="n">child_observations_R</span><span class="p">,</span>
                            <span class="n">ID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_ID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">parent_node</span><span class="o">.</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">parent_ID</span> <span class="o">=</span> <span class="n">parent_node</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">child_node_L</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_ID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">child_node_R</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_ID</span> <span class="o">+=</span> <span class="mi">2</span>
                
            
    <span class="c1">#############################</span>
    <span class="c1">####### 2. PREDICTING #######</span>
    <span class="c1">#############################</span>
    
    <span class="c1">###### LEAF MODES ######</span>
    <span class="k">def</span> <span class="nf">_get_leaf_modes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leaf_modes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">node_ID</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">leaf</span><span class="p">:</span>
                <span class="n">values</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ysub</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">leaf_modes</span><span class="p">[</span><span class="n">node_ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">counts</span><span class="p">)]</span>
    
    <span class="c1">####### PREDICT ########</span>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">):</span>
        
        <span class="c1"># Calculate leaf modes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_leaf_modes</span><span class="p">()</span>
        
        <span class="n">yhat</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">X_test</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
            <span class="k">while</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">leaf</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;quant&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">d</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">node</span><span class="o">.</span><span class="n">t</span><span class="p">:</span>
                        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_dict</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">child_L</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_dict</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">child_R</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">d</span><span class="p">]</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">L_values</span><span class="p">:</span>
                        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_dict</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">child_L</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_dict</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">child_R</span><span class="p">]</span>
            <span class="n">yhat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">leaf_modes</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">ID</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yhat</span><span class="p">)</span>
            
</pre></div>
</div>
</div>
</div>
<p>With the weighted decision tree constructed, we are ready to build our <code class="docutils literal notranslate"><span class="pre">AdaBoost</span></code> class. The class closely follows the algorithm introduced in the content section, which is copied below for convenience.</p>
<hr class="docutils" />
<p><strong>Discrete AdaBoost Algorithm</strong></p>
<p>Define the target variable to be <span class="math notranslate nohighlight">\(y_n \in \{-1, +1 \}\)</span>.</p>
<ol>
<li><p>Initialize the weights with <span class="math notranslate nohighlight">\(w^1_n = \frac{1}{N}\)</span> for <span class="math notranslate nohighlight">\(n = 1, 2, \dots, N\)</span>.</p></li>
<li><p>For <span class="math notranslate nohighlight">\(t = 1, \dots, T\)</span>,</p>
<ul>
<li><p>Build weak learner <span class="math notranslate nohighlight">\(t\)</span> using weights <span class="math notranslate nohighlight">\(\mathbf{w}^t\)</span>.</p></li>
<li><p>Calculate fitted values <span class="math notranslate nohighlight">\(f^t(\bx_n) \in \{-1, +1\}\)</span> for <span class="math notranslate nohighlight">\(n = 1, 2, \dots, N\)</span>. Let <span class="math notranslate nohighlight">\(I^t_n\)</span> equal 1 If <span class="math notranslate nohighlight">\(f^t(\bx_n) \neq y_n\)</span> and 0 otherwise. That is, <span class="math notranslate nohighlight">\(I^t_n\)</span> indicates whether learner <span class="math notranslate nohighlight">\(t\)</span> misclassifies observation <span class="math notranslate nohighlight">\(n\)</span>.</p></li>
<li><p>Calculate the weighted error for learner <span class="math notranslate nohighlight">\(t\)</span>:</p>
<div class="math notranslate nohighlight">
\[
     \epsilon^t = \frac{\sumN w^t_n I^t_n}{\sumN w^t_n}.
     \]</div>
</li>
<li><p>Calculate the accuracy measure for learner <span class="math notranslate nohighlight">\(t\)</span>:</p>
<div class="math notranslate nohighlight">
\[
     \alpha^t = \log\left(\frac{1-\epsilon^t}{\epsilon^t}\right).
     \]</div>
</li>
<li><p>Update the weighting with</p>
<div class="math notranslate nohighlight">
\[
     w^{t + 1}_n = w^t_n\exp(\alpha^tI^t_n),
     \]</div>
<p>for <span class="math notranslate nohighlight">\(n = 1, 2, \dots, N\)</span>.</p>
</li>
</ul>
</li>
<li><p>Calculate the overall fitted values with <span class="math notranslate nohighlight">\(\hat{y}_n = \text{sign} \left( \sum_{t = 1}^T \alpha^t f^t(\bx_n)\right)\)</span>.</p></li>
</ol>
<hr class="docutils" />
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AdaBoost</span><span class="p">:</span>
    
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">stub_depth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stub_depth</span> <span class="o">=</span> <span class="n">stub_depth</span>
        
        <span class="c1">## Instantiate stuff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trees</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alphas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yhats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">):</span>
            
            <span class="c1">## Calculate stuff</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">T_t</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">T_t</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">max_depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stub_depth</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">yhat_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_t</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_t</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yhat_t</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">))</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">epsilon_t</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">epsilon_t</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">epsilon_t</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">epsilon_t</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">yhat_t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                                    <span class="k">else</span> <span class="n">w</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)])</span>
            <span class="c1">## Append stuff</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_t</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alphas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_t</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">yhats</span><span class="p">[:,</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yhat_t</span> 
            
        <span class="bp">self</span><span class="o">.</span><span class="n">yhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yhats</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alphas</span><span class="p">))</span>
        
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">):</span>
        <span class="n">yhats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">tree</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">):</span>
            <span class="n">yhats_tree</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
            <span class="n">yhats</span> <span class="o">+=</span> <span class="n">yhats_tree</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">alphas</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">yhats</span><span class="p">)</span>
        
        
        
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">AdaBoost</span></code> model is finally fit below. To train the model, we supply the training data as well as <code class="docutils literal notranslate"><span class="pre">T</span></code>—the number of weak learners—and <code class="docutils literal notranslate"><span class="pre">stub_depth</span></code>—the depth for each tree (our weak learner).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">booster</span> <span class="o">=</span> <span class="n">AdaBoost</span><span class="p">()</span>
<span class="n">booster</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">stub_depth</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">yhat</span> <span class="o">=</span> <span class="n">booster</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">yhat</span> <span class="o">==</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9759036144578314
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="regression-with-adaboost-r2">
<h2>2. Regression with AdaBoost.R2<a class="headerlink" href="#regression-with-adaboost-r2" title="Permalink to this headline">¶</a></h2>
<p>Next, let’s implement <em>AdaBoost.R2</em>, a common boosting algorithm for regression tasks. We’ll again use the <a class="reference internal" href="../../appendix/data.html"><span class="doc">tips</span></a> dataset from <code class="docutils literal notranslate"><span class="pre">seaborn</span></code>, loaded in the hidden code cell below.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Import packages</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span> 
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">datasets</span>

<span class="c1">## Load data</span>
<span class="n">tips</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;tips&#39;</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tips</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="s1">&#39;tip&#39;</span><span class="p">))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tips</span><span class="p">[</span><span class="s1">&#39;tip&#39;</span><span class="p">])</span>

<span class="c1">## Train-test split</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_frac</span> <span class="o">=</span> <span class="mf">0.25</span>
<span class="n">test_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="n">test_frac</span><span class="p">)</span>
<span class="n">test_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="n">test_size</span><span class="p">,</span> <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">test_idxs</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">test_idxs</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">test_idxs</span><span class="p">]</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">test_idxs</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Since our boosting class will use regression trees for its weak learners, let’s also import the regression tree we constructed in <a class="reference internal" href="../../c5/s2/regression_tree.html"><span class="doc">Chapter 5</span></a>.</p>
<div class="cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Import decision trees</span>
<span class="kn">import</span> <span class="nn">import_ipynb</span>
<span class="kn">import</span> <span class="nn">regression_tree</span> <span class="k">as</span> <span class="nn">rt</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
<p>Recall that the final fitted values in <em>AdaBoost.R2</em> are based on a weighted median. Let’s first make a helper function to return the weighted median.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">weighted_median</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
    
    <span class="n">sorted_indices</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">sorted_indices</span><span class="p">]</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">sorted_indices</span><span class="p">]</span>
    <span class="n">weights_cumulative_sum</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="n">median_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">weights_cumulative_sum</span> <span class="o">&gt;=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">values</span><span class="p">[</span><span class="n">median_weight</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We can then fit the <code class="docutils literal notranslate"><span class="pre">AdaBoostR2</span></code> class. This again follows the algorithm closely, which is again copied below for convenience.</p>
<hr class="docutils" />
<p><strong>AdaBoost.R2 Algorithm</strong></p>
<ol>
<li><p>Initialize the weights with <span class="math notranslate nohighlight">\(w^1_n = \frac{1}{N}\)</span> for <span class="math notranslate nohighlight">\(n = 1, 2, \dots, N\)</span>.</p></li>
<li><p>For <span class="math notranslate nohighlight">\(t = 1, 2, \dots, T\)</span> or while <span class="math notranslate nohighlight">\(\bar{L}^t\)</span>, as defined below, is less than or equal to 0.5,</p>
<ul class="simple">
<li><p>Draw a sample of size <span class="math notranslate nohighlight">\(N\)</span> from the training data with replacement and with probability <span class="math notranslate nohighlight">\(w^t_n\)</span> for <span class="math notranslate nohighlight">\(n = 1, 2, \dots, N\)</span>.</p></li>
<li><p>Fit weak learner <span class="math notranslate nohighlight">\(t\)</span> to the resampled data and calculate the fitted values on the original dataset. Denote these fitted values with <span class="math notranslate nohighlight">\(f^t(\bx_{n})\)</span> for <span class="math notranslate nohighlight">\(n = 1, 2, \dots, N\)</span>.</p></li>
<li><p>Calculate the observation error <span class="math notranslate nohighlight">\(L^t_{n}\)</span> for <span class="math notranslate nohighlight">\(n = 1, 2, \dots, N\)</span>:</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\begin{split}
   \begin{aligned}
   D^t &amp;= \underset{n}{\text{max}} \{ |y_{n} - f^t(\bx_{n})|  \} \\
   L^t_{n} &amp;= \frac{|y_{n} - f^t(\bx_{n})|}{D^t}
   \end{aligned}
   \end{split}\]</div>
<ul>
<li><p>Calculate the model error <span class="math notranslate nohighlight">\(\bar{L}^t\)</span>:</p>
<div class="math notranslate nohighlight">
\[
     \bar{L}^t = \sum_{n = 1}^N  L^t_n w^t_n
     \]</div>
<p>If <span class="math notranslate nohighlight">\(\bar{L}^t \geq 0.5\)</span>, end iteration and set <span class="math notranslate nohighlight">\(T\)</span> equal to <span class="math notranslate nohighlight">\(t - 1\)</span>.</p>
</li>
<li><p>Let <span class="math notranslate nohighlight">\(\beta^t = \frac{\bar{L}^t}{1- \bar{L}^t}\)</span>. The lower <span class="math notranslate nohighlight">\(\beta^t\)</span>, the greater our confidence in the model.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(Z^t = \sum_{n = 1}^N w^t_n (\beta^t)^{1 - L_n}\)</span> and update the model weights with</p>
<div class="math notranslate nohighlight">
\[
     w^{t + 1}_n = \frac{w^t_n (\beta^t)^{1 - L_n}}{Z^t},
     \]</div>
<p>which increases the weight for observations with a greater error <span class="math notranslate nohighlight">\(L^t_n\)</span>.</p>
</li>
</ul>
</li>
<li><p>Set the overall fitted value for observation <span class="math notranslate nohighlight">\(n\)</span> equal to the weighted median of <span class="math notranslate nohighlight">\(f^t(\bx_n)\)</span> for <span class="math notranslate nohighlight">\(t = 1, 2, \dots, T\)</span> using weights <span class="math notranslate nohighlight">\(\log(1/\beta^t)\)</span> for model <span class="math notranslate nohighlight">\(t\)</span>.</p></li>
</ol>
<hr class="docutils" />
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AdaBoostR2</span><span class="p">:</span>
    
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">stub_depth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stub_depth</span> <span class="o">=</span> <span class="n">stub_depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">trees</span> <span class="o">=</span> <span class="p">[]</span>    
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">betas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">):</span>
            
            <span class="c1">## Draw sample, fit tree, get predictions</span>
            <span class="n">bootstrap_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">),</span> <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">replace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
            <span class="n">bootstrap_X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="p">[</span><span class="n">bootstrap_indices</span><span class="p">]</span>
            <span class="n">bootstrap_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">[</span><span class="n">bootstrap_indices</span><span class="p">]</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">rt</span><span class="o">.</span><span class="n">DecisionTreeRegressor</span><span class="p">()</span>
            <span class="n">tree</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">bootstrap_X</span><span class="p">,</span> <span class="n">bootstrap_y</span><span class="p">,</span> <span class="n">max_depth</span> <span class="o">=</span> <span class="n">stub_depth</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
            <span class="n">yhat</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fitted_values</span><span class="p">[:,</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">yhat</span>
            
            <span class="c1">## Calculate observation errors</span>
            <span class="n">abs_errors_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_train</span> <span class="o">-</span> <span class="n">yhat</span><span class="p">)</span>
            <span class="n">D_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">abs_errors_t</span><span class="p">)</span>
            <span class="n">L_ts</span> <span class="o">=</span> <span class="n">abs_errors_t</span><span class="o">/</span><span class="n">D_t</span>
            
            <span class="c1">## Calculate model error (and possibly break)</span>
            <span class="n">Lbar_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">*</span><span class="n">L_ts</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">Lbar_t</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fitted_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_values</span><span class="p">[:,:</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trees</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">[:</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">break</span>
            
            <span class="c1">## Calculate and record beta </span>
            <span class="n">beta_t</span> <span class="o">=</span> <span class="n">Lbar_t</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Lbar_t</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">betas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">beta_t</span><span class="p">)</span>
            
            <span class="c1">## Reweight</span>
            <span class="n">Z_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">*</span><span class="n">beta_t</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">L_ts</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">*=</span> <span class="n">beta_t</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">L_ts</span><span class="p">)</span><span class="o">/</span><span class="n">Z_t</span>
            
        <span class="c1">## Get median </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">betas</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_train_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">weighted_median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitted_values</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_weights</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)])</span>
        
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">):</span>
        <span class="n">N_test</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
        <span class="n">fitted_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">N_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">tree</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">):</span>
            <span class="n">fitted_values</span><span class="p">[:,</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">weighted_median</span><span class="p">(</span><span class="n">fitted_values</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_weights</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_test</span><span class="p">)])</span> 
        
        
</pre></div>
</div>
</div>
</div>
<p>Again, we fit our booster by providing training data in addition to <code class="docutils literal notranslate"><span class="pre">T</span></code>—the number of weak learners—and <code class="docutils literal notranslate"><span class="pre">stub_depth</span></code>—the depth for our regression tree weak learners.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">booster</span> <span class="o">=</span> <span class="n">AdaBoostR2</span><span class="p">()</span>
<span class="n">booster</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">stub_depth</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="mi">123</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">booster</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">));</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$y$&#39;</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\hat</span><span class="si">{y}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Fitted vs. Observed Values for AdaBoostR2&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/boosting_24_0.png" src="../../../_images/boosting_24_0.png" />
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./content/c6/s2"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="random_forests.html" title="previous page">Random Forests</a>
    <a class='right-next' id="next-link" href="../code.html" title="next page">Implementation</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Danny Friedman<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    <script src="../../../_static/js/index.js"></script>
    
  </body>
</html>