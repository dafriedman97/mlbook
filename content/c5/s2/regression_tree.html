

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Regression Trees &#8212; Machine Learning from Scratch</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous">
    <link href="../../../_static/css/index.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../_static/sphinx-book-theme.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/jupyter-sphinx.css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/sphinx-book-theme.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script src="../../../_static/togglebutton.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/mystnb.js"></script>
    <script src="../../../_static/sphinx-book-theme.js"></script>
    <script >var togglebuttonSelector = '.toggle, .secondtoggle, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.18.0/dist/embed-amd.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"TeX": {"Macros": {"sumN": "\\sum_{n = 1}^N", "sumn": "\\sum_{n}", "prodN": "\\prod_{n = 1}^N", "bx": "\\mathbf{x}", "by": "\\mathbf{y}", "bX": "\\mathbf{X}", "bY": "\\mathbf{Y}", "bT": "\\mathbf{T}", "bbeta": "\\boldsymbol{\\beta}", "btheta": "\\boldsymbol{\\hat{\\theta}}}", "bmu": "\\boldsymbol{\\mu}", "bSigma": "\\boldsymbol{\\Sigma}", "bbetahat": "\\boldsymbol{\\hat{\\beta}}", "bbR": "\\mathbb{R}", "iid": "\\overset{\\small{\\text{i.i.d.}}}{\\sim}}", "dadb": ["{\\frac{\\partial #1}{\\partial #2}}", 2], "testing": "\\TeX", "R": "\\mathbb{R}"}}})</script>
    <link rel="shortcut icon" href="../../../_static/logo.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Classification Trees" href="classification_tree.html" />
    <link rel="prev" title="Construction" href="../construction.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="docsearch:language" content="en">



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../../../index.html">
  
  <img src="../../../_static/logo.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">Machine Learning from Scratch</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  
  <ul class="nav sidenav_l1">
  <li class="">
    <a href="../../table_of_contents.html">Table of Contents</a>
  </li>
  <li class="">
    <a href="../../conventions_notation.html">Conventions and Notation</a>
  </li>
<li class="navbar-special">
<p class="margin-caption">1. Ordinary Linear Regression</p>
</li>
  <li class="">
    <a href="../../c1/concept.html">Concept</a>
  </li>
  <li class="">
    <a href="../../c1/construction.html">Construction</a>
  </li>
  <li class="">
    <a href="../../c1/code.html">Code</a>
  </li>
<li class="navbar-special">
<p class="margin-caption">2. Linear Regression Extensions</p>
</li>
  <li class="">
    <a href="../../c2/concept.html">Concept</a>
  </li>
  <li class="">
    <a href="../../c2/construction.html">Construction</a>
  </li>
  <li class="">
    <a href="../../c2/code.html">Code</a>
  </li>
<li class="navbar-special">
<p class="margin-caption">3. Discriminative Classifiers (Logistic Regression)</p>
</li>
  <li class="">
    <a href="../../c3/concept.html">Concept</a>
  </li>
  <li class="">
    <a href="../../c3/construction.html">Construction</a>
  </li>
  <li class="">
    <a href="../../c3/code.html">Code</a>
  </li>
<li class="navbar-special">
<p class="margin-caption">4. Generative Classifiers (Naive Bayes)</p>
</li>
  <li class="">
    <a href="../../c4/concept.html">Concept</a>
  </li>
  <li class="">
    <a href="../../c4/construction.html">Construction</a>
  </li>
  <li class="">
    <a href="../../c4/code.html">Code</a>
  </li>
<li class="navbar-special">
<p class="margin-caption">5. Decision Trees</p>
</li>
  <li class="">
    <a href="../concept.html">Concept</a>
  </li>
  <li class="active">
    <a href="../construction.html">Construction</a>
  <ul class="nav sidenav_l2">
    <li class="active">
      <a href="">Regression Trees</a>
    </li>
    <li class="">
      <a href="classification_tree.html">Classification Trees</a>
    </li>
  </ul>
  </li>
  <li class="">
    <a href="../code.html">Code</a>
  </li>
<li class="navbar-special">
<p class="margin-caption">6. Tree Ensemble Methods</p>
</li>
  <li class="">
    <a href="../../c6/concept.html">Concept</a>
  </li>
  <li class="">
    <a href="../../c6/construction.html">Construction</a>
  </li>
  <li class="">
    <a href="../../c6/code.html">Code</a>
  </li>
<li class="navbar-special">
<p class="margin-caption">7. Neural Networks</p>
</li>
  <li class="">
    <a href="../../c7/concept.html">Concept</a>
  </li>
  <li class="">
    <a href="../../c7/construction.html">Construction</a>
  </li>
  <li class="">
    <a href="../../c7/code.html">Code</a>
  </li>
<li class="navbar-special">
<p class="margin-caption">Appendix</p>
</li>
  <li class="">
    <a href="../../appendix/math.html">Math</a>
  </li>
  <li class="">
    <a href="../../appendix/probability.html">Probability</a>
  </li>
  <li class="">
    <a href="../../appendix/methods.html">Common Methods</a>
  </li>
  <li class="">
    <a href="../../appendix/data.html">Datasets</a>
  </li>
</ul>
</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse" data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu" aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation" title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
            <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i class="fas fa-download"></i></button>

            
            <div class="dropdown-buttons">
                <!-- ipynb file if we had a myst markdown file -->
                
                <!-- Download raw file -->
                <a class="dropdown-buttons" href="../../../_sources/content/c5/s2/regression_tree.ipynb.txt"><button type="button" class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip" data-placement="left">.ipynb</button></a>
                <!-- Download PDF via print -->
                <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF" onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
            </div>
            
        </div>

        <!-- Edit this page -->
        <a class="edit-button" href="https://github.com/dafriedman97/book/edit/master/content/c5/s2/regression_tree.ipynb"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="bottom" title="Edit this page"><i class="fas fa-pencil-alt"></i></button></a>

        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="bottom" onclick="toggleFullScreen()" title="Fullscreen mode"><i class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->
        
        <div class="dropdown-buttons-trigger">
            <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
            <div class="dropdown-buttons">
                
                <a class="binder-button" href="https://mybinder.org/v2/gh/dafriedman97/book/master?urlpath=tree/content/c5/s2/regression_tree.ipynb"><button type="button" class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip" data-placement="left"><img class="binder-button-logo" src="../../../_static/images/logo_binder.svg" alt="Interact on binder">Binder</button></a>
                
                
                
            </div>
        </div>
        
    </div>
    <div class="d-none d-md-block col-md-2 bd-toc show">
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="nav section-nav flex-column">
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#helper-functions" class="nav-link">1. Helper Functions</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#helper-classes" class="nav-link">2. Helper Classes</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#main-class" class="nav-link">3. Main Class</a>
        </li>
    
    </ul>
</nav>



<div class="tocsection editthispage">
    <a href="https://github.com/dafriedman97/book/edit/master/content/c5/s2/regression_tree.ipynb">
        <i class="fas fa-pencil-alt"></i> Edit this page
    </a>
</div>

    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="regression-trees">
<h1>Regression Trees<a class="headerlink" href="#regression-trees" title="Permalink to this headline">¶</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## Import packages</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span> 
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">datasets</span>

<span class="c1">## Load data</span>
<span class="n">tips</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;tips&#39;</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tips</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="s1">&#39;tip&#39;</span><span class="p">))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tips</span><span class="p">[</span><span class="s1">&#39;tip&#39;</span><span class="p">])</span>

<span class="c1">## Train-test split</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_frac</span> <span class="o">=</span> <span class="mf">0.25</span>
<span class="n">test_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="n">test_frac</span><span class="p">)</span>
<span class="n">test_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="n">test_size</span><span class="p">,</span> <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">test_idxs</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">test_idxs</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">test_idxs</span><span class="p">]</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">test_idxs</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Because of their iterative structure, their exhaustive searching, and their non-parametric nature, decision trees are more computationally complex than methods we’ve seen previously. To clear things up, the construction code is divided into three sections: helper functions, helper classes, and the main decision tree regressor class.</p>
<p>We will build our regression tree on the <a class="reference internal" href="../../appendix/data.html"><span class="doc">tips</span></a> dataset from <code class="docutils literal notranslate"><span class="pre">seaborn</span></code>. This dataset has a continuous target variable (tip amount) with both quantitative and categorical predictors. Recall that trees are able to handle categorical predictors without creating one-hot encoded variables, unlike other methods we’ve seen.</p>
<div class="section" id="helper-functions">
<h2>1. Helper Functions<a class="headerlink" href="#helper-functions" title="Permalink to this headline">¶</a></h2>
<p>Below are three helper functions we will use in our regression tree. <code class="docutils literal notranslate"><span class="pre">RSS_reduction()</span></code> measures how much a split reduces a parent node’s <span class="math notranslate nohighlight">\(RSS\)</span> by subtracting the sum of the child <span class="math notranslate nohighlight">\(RSS\)</span> values from the parent <span class="math notranslate nohighlight">\(RSS\)</span>. We will use this to determine the best split for any given bud.</p>
<p>The next function, <code class="docutils literal notranslate"><span class="pre">sort_x_by_y()</span></code>, returns a sorted list of the unique categories in some predictor <code class="docutils literal notranslate"><span class="pre">x</span></code> according to the mean of the corresponding target values <code class="docutils literal notranslate"><span class="pre">y</span></code>. We will use this to search for splits on categorical predictors.</p>
<p>Finally, <code class="docutils literal notranslate"><span class="pre">all_rows_equal()</span></code> checks if all of a bud’s rows (observations) are equal across all predictors. If this is the case, this bud will not be split and instead becomes a terminal leaf.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">RSS_reduction</span><span class="p">(</span><span class="n">child_L</span><span class="p">,</span> <span class="n">child_R</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
    <span class="n">rss_parent</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">parent</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">rss_child_L</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">child_L</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">child_L</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> 
    <span class="n">rss_child_R</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">child_R</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">child_R</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rss_parent</span> <span class="o">-</span> <span class="p">(</span><span class="n">rss_child_L</span> <span class="o">+</span> <span class="n">rss_child_R</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">sort_x_by_y</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">unique_xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y_mean_by_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="n">x</span> <span class="o">==</span> <span class="n">unique_x</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">for</span> <span class="n">unique_x</span> <span class="ow">in</span> <span class="n">unique_xs</span><span class="p">])</span>
    <span class="n">ordered_xs</span> <span class="o">=</span> <span class="n">unique_xs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">y_mean_by_x</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">ordered_xs</span>

<span class="k">def</span> <span class="nf">all_rows_equal</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">X</span> <span class="o">==</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="helper-classes">
<h2>2. Helper Classes<a class="headerlink" href="#helper-classes" title="Permalink to this headline">¶</a></h2>
<p>Below are two helpful classes for our main regression tree class. The first, <code class="docutils literal notranslate"><span class="pre">Node</span></code>, represents nodes within our tree. They identify a node’s ID and the ID of its parent, its sample of the predictors and the target variable, its size, its depth, and whether or not it is a leaf.</p>
<p>The second, <code class="docutils literal notranslate"><span class="pre">Splitter</span></code>, is used to identify the best split of any given bud. It identifies the split’s reduction in <span class="math notranslate nohighlight">\(RSS\)</span>; the variable, <code class="docutils literal notranslate"><span class="pre">d</span></code>, used to make the split; the variable’s data type; and the threshold, <code class="docutils literal notranslate"><span class="pre">t</span></code>, (if quantitative) or the set of values, <code class="docutils literal notranslate"><span class="pre">L_values</span></code>, corresponding to the left child node (if categorical). The <code class="docutils literal notranslate"><span class="pre">Splitter</span></code> class fills in these values with its <code class="docutils literal notranslate"><span class="pre">_replace_split()</span></code> method. This method is called if we find a split better than the best split so far.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Node</span><span class="p">:</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Xsub</span><span class="p">,</span> <span class="n">ysub</span><span class="p">,</span> <span class="n">ID</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">parent_ID</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">leaf</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ID</span> <span class="o">=</span> <span class="n">ID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Xsub</span> <span class="o">=</span> <span class="n">Xsub</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ysub</span> <span class="o">=</span> <span class="n">ysub</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ysub</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_ID</span> <span class="o">=</span> <span class="n">parent_ID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leaf</span> <span class="o">=</span> <span class="n">leaf</span>
        
<span class="k">class</span> <span class="nc">Splitter</span><span class="p">:</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rss_reduction</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_split</span> <span class="o">=</span> <span class="kc">True</span>
        
    <span class="k">def</span> <span class="nf">_replace_split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rss_reduction</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;quant&#39;</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">L_values</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rss_reduction</span> <span class="o">=</span> <span class="n">rss_reduction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">t</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">L_values</span> <span class="o">=</span> <span class="n">L_values</span>     
        <span class="bp">self</span><span class="o">.</span><span class="n">no_split</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="main-class">
<h2>3. Main Class<a class="headerlink" href="#main-class" title="Permalink to this headline">¶</a></h2>
<p>We are now ready to build our main class, the decision tree regressor. The class serves two primary functions: training the model and forming predictions with a trained model. The training is comprised of four methods: <code class="docutils literal notranslate"><span class="pre">fit()</span></code>, <code class="docutils literal notranslate"><span class="pre">_build()</span></code>, <code class="docutils literal notranslate"><span class="pre">_find_split()</span></code>, and <code class="docutils literal notranslate"><span class="pre">_make_split()</span></code>. These methods are covered next.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">fit()</span></code>: After instantiating a decision tree object, the user provides training data and calls the <code class="docutils literal notranslate"><span class="pre">fit()</span></code> method. This is the only training method that the user directly calls. The method first records the data and regularization parameters. Then it instantiates a dictionary to store the nodes, called <code class="docutils literal notranslate"><span class="pre">nodes_dict</span></code>, in which nodes are indexed by their IDs. Finally, it calls the <code class="docutils literal notranslate"><span class="pre">_build()</span></code> method to build the tree.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_build()</span></code>: As its name suggests, the <code class="docutils literal notranslate"><span class="pre">_build()</span></code> method actually builds our tree. It relies on the <code class="docutils literal notranslate"><span class="pre">_find_split()</span></code> and <code class="docutils literal notranslate"><span class="pre">_make_split()</span></code> methods discussed next. The method iterates through layers of the tree (starting with just the initial node), splitting each eligible bud before proceeding to the next layer. The eligible buds are tracked by the <code class="docutils literal notranslate"><span class="pre">eligible_buds</span></code> dictionary. A bud is eligible for splitting if it does not already have children (i.e. is a leaf); if it is not smaller than <code class="docutils literal notranslate"><span class="pre">min_size</span></code>, a regularization parameter provided by the user; if its observations are not identical across all predictors; and if it has more than one unique value of the target variable. For each eligible bud, we find a split and make a split, as discussed below. This process continues until there are no eligible buds or we have reached the tree’s maximum depth, determined by the argument <code class="docutils literal notranslate"><span class="pre">max_depth</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_find_split()</span></code>: When looping through eligible buds in the <code class="docutils literal notranslate"><span class="pre">_build()</span></code> method, we determine their splits with the <code class="docutils literal notranslate"><span class="pre">_find_split()</span></code> method. This method instantaites an object of the <code class="docutils literal notranslate"><span class="pre">Splitter</span></code> class described above. It then loops through all predictors and all possible splits of that predictor to determine which split most reduces the bud’s <span class="math notranslate nohighlight">\(RSS\)</span>. If the predictor is quantitative, we loop through each unique value and calculate the <span class="math notranslate nohighlight">\(RSS\)</span> reduction from splitting at that threshold. If the predictor is categorical, we first call <code class="docutils literal notranslate"><span class="pre">sort_x_by_y()</span></code> to order the categories of <code class="docutils literal notranslate"><span class="pre">x</span></code>, and then calculate the <span class="math notranslate nohighlight">\(RSS\)</span> reduction for the following splits, where the ordered categories are given by <span class="math notranslate nohighlight">\(c_1, \dots, c_V\)</span>.</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
\{c_1\} &amp;\text{ vs. } \{c_2, \dots, c_V\}\\
\{c_1, c_2\} &amp;\text{ vs. } \{c_3, \dots, c_V\}\\
&amp; \dots \\
\{c_1, \dots c_{V-1} \} &amp;\text{ vs. } \{c_V\}.\\
\end{align*}
\end{split}\]</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">_make_split()</span></code>: Once identified, splits are actually conducted with the <code class="docutils literal notranslate"><span class="pre">_make_split()</span></code> method. This method updates the parent node with the split information and creates the two child nodes. For the parent node, we record which predictor was used to make the split and how. We also add the IDs of the child nodes. For each child node, we record the training observations passing through the node, its ID, its parent’s ID, and its size and depth</p></li>
</ul>
<p>Finally, we use our built tree to form predictions. This is a two step process. First, we use the <code class="docutils literal notranslate"><span class="pre">_get_leaf_means()</span></code> method to calculate the average of the target variable among training observations landing in each leaf. Then we use <code class="docutils literal notranslate"><span class="pre">predict()</span></code> to run each test observation through the tree and return a fitted value: the mean target variable in the corresponding leaf. Note that the user only directly calls <code class="docutils literal notranslate"><span class="pre">predict()</span></code>, which itself calls <code class="docutils literal notranslate"><span class="pre">_get_leaf_means()</span></code>.</p>
<div class="alert alert-info">
<p class="admonition-title">Note</p>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">_fit()</span></code> and <code class="docutils literal notranslate"><span class="pre">_find_split()</span></code> methods refer to an argument <code class="docutils literal notranslate"><span class="pre">C</span></code>. This parameter is used by random forests, which are discussed in chapter 6. This argument can be ignored for the purposes of building a decision tree.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DecisionTreeRegressor</span><span class="p">:</span>
    
    <span class="c1">#############################</span>
    <span class="c1">######## 1. TRAINING ########</span>
    <span class="c1">#############################</span>
    
    <span class="c1">######### FIT ##########</span>
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">max_depth</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">min_size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        
        <span class="c1">## Add data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">X</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">dtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[:,</span><span class="n">d</span><span class="p">]))</span><span class="o">.</span><span class="n">dtype</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;quant&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">float</span> <span class="ow">or</span> <span class="n">dtype</span> <span class="o">==</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;cat&#39;</span> <span class="k">for</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">dtypes</span><span class="p">]</span>
        
        <span class="c1">## Add regularization parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">max_depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_size</span> <span class="o">=</span> <span class="n">min_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">C</span>
        
        <span class="c1">## Initialize nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_ID</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">initial_node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">Xsub</span> <span class="o">=</span> <span class="n">X</span><span class="p">,</span> <span class="n">ysub</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">ID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_ID</span><span class="p">,</span> <span class="n">parent_ID</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_ID</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1">## Build</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build</span><span class="p">()</span>
        
    <span class="c1">###### BUILD TREE ######</span>
    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">eligible_buds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_dict</span> 
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">):</span>
            
            <span class="c1">## Find eligible nodes for layer iteration</span>
            <span class="n">eligible_buds</span> <span class="o">=</span> <span class="p">{</span><span class="n">ID</span><span class="p">:</span><span class="n">node</span> <span class="k">for</span> <span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> 
                                <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">leaf</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span>
                                <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_size</span><span class="p">)</span> <span class="o">&amp;</span> 
                                <span class="p">(</span><span class="o">~</span><span class="n">all_rows_equal</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Xsub</span><span class="p">))</span> <span class="o">&amp;</span>
                                <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ysub</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)}</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eligible_buds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
                
            <span class="c1">## split each eligible parent</span>
            <span class="k">for</span> <span class="n">ID</span><span class="p">,</span> <span class="n">bud</span> <span class="ow">in</span> <span class="n">eligible_buds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                
                <span class="c1">## Find split</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_find_split</span><span class="p">(</span><span class="n">bud</span><span class="p">)</span>
                
                <span class="c1">## Make split</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">no_split</span><span class="p">:</span> <span class="c1"># could be no split for Random Forest</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_make_split</span><span class="p">()</span>
        
    
    <span class="c1">###### FIND SPLIT ######</span>
    <span class="k">def</span> <span class="nf">_find_split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bud</span><span class="p">):</span>
        
        <span class="c1">## Instantiate splitter</span>
        <span class="n">splitter</span> <span class="o">=</span> <span class="n">Splitter</span><span class="p">()</span>
        <span class="n">splitter</span><span class="o">.</span><span class="n">bud_ID</span> <span class="o">=</span> <span class="n">bud</span><span class="o">.</span><span class="n">ID</span>
        
        <span class="c1">## Gather eligible predictors (for Random Forests)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">eligible_predictors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eligible_predictors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="p">,</span> <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        
        <span class="c1">## For each (eligible) predictor...</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">eligible_predictors</span><span class="p">):</span>
            <span class="n">Xsub_d</span> <span class="o">=</span> <span class="n">bud</span><span class="o">.</span><span class="n">Xsub</span><span class="p">[:,</span><span class="n">d</span><span class="p">]</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">Xsub_d</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1">## For each threshold value...</span>
            <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;quant&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">Xsub_d</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">ysub_L</span> <span class="o">=</span> <span class="n">bud</span><span class="o">.</span><span class="n">ysub</span><span class="p">[</span><span class="n">Xsub_d</span> <span class="o">&lt;=</span> <span class="n">t</span><span class="p">]</span>
                    <span class="n">ysub_R</span> <span class="o">=</span> <span class="n">bud</span><span class="o">.</span><span class="n">ysub</span><span class="p">[</span><span class="n">Xsub_d</span> <span class="o">&gt;</span> <span class="n">t</span><span class="p">]</span>
                    <span class="n">rss_reduction</span> <span class="o">=</span> <span class="n">RSS_reduction</span><span class="p">(</span><span class="n">ysub_L</span><span class="p">,</span> <span class="n">ysub_R</span><span class="p">,</span> <span class="n">bud</span><span class="o">.</span><span class="n">ysub</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">rss_reduction</span> <span class="o">&gt;</span> <span class="n">splitter</span><span class="o">.</span><span class="n">rss_reduction</span><span class="p">:</span>
                        <span class="n">splitter</span><span class="o">.</span><span class="n">_replace_split</span><span class="p">(</span><span class="n">rss_reduction</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;quant&#39;</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ordered_x</span> <span class="o">=</span> <span class="n">sort_x_by_y</span><span class="p">(</span><span class="n">Xsub_d</span><span class="p">,</span> <span class="n">bud</span><span class="o">.</span><span class="n">ysub</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ordered_x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">L_values</span> <span class="o">=</span> <span class="n">ordered_x</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">ysub_L</span> <span class="o">=</span> <span class="n">bud</span><span class="o">.</span><span class="n">ysub</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">Xsub_d</span><span class="p">,</span> <span class="n">L_values</span><span class="p">)]</span>
                    <span class="n">ysub_R</span> <span class="o">=</span> <span class="n">bud</span><span class="o">.</span><span class="n">ysub</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">Xsub_d</span><span class="p">,</span> <span class="n">L_values</span><span class="p">)]</span>
                    <span class="n">rss_reduction</span> <span class="o">=</span> <span class="n">RSS_reduction</span><span class="p">(</span><span class="n">ysub_L</span><span class="p">,</span> <span class="n">ysub_R</span><span class="p">,</span> <span class="n">bud</span><span class="o">.</span><span class="n">ysub</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">rss_reduction</span> <span class="o">&gt;</span> <span class="n">splitter</span><span class="o">.</span><span class="n">rss_reduction</span><span class="p">:</span> 
                        <span class="n">splitter</span><span class="o">.</span><span class="n">_replace_split</span><span class="p">(</span><span class="n">rss_reduction</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">L_values</span> <span class="o">=</span> <span class="n">L_values</span><span class="p">)</span>
        
        <span class="c1">## Save splitter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span> <span class="o">=</span> <span class="n">splitter</span>
        
    <span class="c1">###### MAKE SPLIT ######</span>
    <span class="k">def</span> <span class="nf">_make_split</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">## Update parent node</span>
        <span class="n">parent_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">bud_ID</span><span class="p">]</span>
        <span class="n">parent_node</span><span class="o">.</span><span class="n">leaf</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">parent_node</span><span class="o">.</span><span class="n">child_L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_ID</span>
        <span class="n">parent_node</span><span class="o">.</span><span class="n">child_R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_ID</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">parent_node</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">d</span>
        <span class="n">parent_node</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">dtype</span>
        <span class="n">parent_node</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">t</span>        
        <span class="n">parent_node</span><span class="o">.</span><span class="n">L_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">L_values</span>
        
        <span class="c1">## Get X and y data for children</span>
        <span class="k">if</span> <span class="n">parent_node</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;quant&#39;</span><span class="p">:</span>
            <span class="n">L_condition</span> <span class="o">=</span> <span class="n">parent_node</span><span class="o">.</span><span class="n">Xsub</span><span class="p">[:,</span><span class="n">parent_node</span><span class="o">.</span><span class="n">d</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">parent_node</span><span class="o">.</span><span class="n">t</span>
     
        <span class="k">else</span><span class="p">:</span>
            <span class="n">L_condition</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">parent_node</span><span class="o">.</span><span class="n">Xsub</span><span class="p">[:,</span><span class="n">parent_node</span><span class="o">.</span><span class="n">d</span><span class="p">],</span> <span class="n">parent_node</span><span class="o">.</span><span class="n">L_values</span><span class="p">)</span>
        <span class="n">Xchild_L</span> <span class="o">=</span> <span class="n">parent_node</span><span class="o">.</span><span class="n">Xsub</span><span class="p">[</span><span class="n">L_condition</span><span class="p">]</span>
        <span class="n">ychild_L</span> <span class="o">=</span> <span class="n">parent_node</span><span class="o">.</span><span class="n">ysub</span><span class="p">[</span><span class="n">L_condition</span><span class="p">]</span>
        <span class="n">Xchild_R</span> <span class="o">=</span> <span class="n">parent_node</span><span class="o">.</span><span class="n">Xsub</span><span class="p">[</span><span class="o">~</span><span class="n">L_condition</span><span class="p">]</span>
        <span class="n">ychild_R</span> <span class="o">=</span> <span class="n">parent_node</span><span class="o">.</span><span class="n">ysub</span><span class="p">[</span><span class="o">~</span><span class="n">L_condition</span><span class="p">]</span>

        
        <span class="c1">## Create child nodes</span>
        <span class="n">child_node_L</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">Xchild_L</span><span class="p">,</span> <span class="n">ychild_L</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">parent_node</span><span class="o">.</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">ID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_ID</span><span class="p">,</span> <span class="n">parent_ID</span> <span class="o">=</span> <span class="n">parent_node</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
        <span class="n">child_node_R</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">Xchild_R</span><span class="p">,</span> <span class="n">ychild_R</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">parent_node</span><span class="o">.</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">ID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_ID</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">parent_ID</span> <span class="o">=</span> <span class="n">parent_node</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">child_node_L</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_ID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">child_node_R</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_ID</span> <span class="o">+=</span> <span class="mi">2</span>
    
                
            
    <span class="c1">#############################</span>
    <span class="c1">####### 2. PREDICTING #######</span>
    <span class="c1">#############################</span>
    
    <span class="c1">###### LEAF MEANS ######</span>
    <span class="k">def</span> <span class="nf">_get_leaf_means</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leaf_means</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">node_ID</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">leaf</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">leaf_means</span><span class="p">[</span><span class="n">node_ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">ysub</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

                
    <span class="c1">####### PREDICT ########</span>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">):</span>
        
        <span class="c1">## Calculate leaf means</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_leaf_means</span><span class="p">()</span>
     
        <span class="n">yhat</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">X_test</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
            <span class="k">while</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">leaf</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;quant&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">d</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">node</span><span class="o">.</span><span class="n">t</span><span class="p">:</span>
                        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_dict</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">child_L</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_dict</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">child_R</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">d</span><span class="p">]</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">L_values</span><span class="p">:</span>
                        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_dict</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">child_L</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_dict</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">child_R</span><span class="p">]</span>
            <span class="n">yhat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">leaf_means</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">ID</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yhat</span><span class="p">)</span>
            
</pre></div>
</div>
</div>
</div>
<p>A regression tree is built below on the <code class="docutils literal notranslate"><span class="pre">tips</span></code> dataset. We also plot the target variable from the test observations against their fitted values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## Build model</span>
<span class="n">tree</span> <span class="o">=</span> <span class="n">DecisionTreeRegressor</span><span class="p">()</span>
<span class="n">tree</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">max_depth</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="n">min_size</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">y_test_hat</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1">## Visualize predictions</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$y$&#39;</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\hat</span><span class="si">{y}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;Test Sample $y$ vs. $\hat</span><span class="si">{y}</span><span class="s1">$&#39;</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/regression_tree_14_0.png" src="../../../_images/regression_tree_14_0.png" />
</div>
</div>
</div>
</div>


              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="../construction.html" title="previous page">Construction</a>
    <a class='right-next' id="next-link" href="classification_tree.html" title="next page">Classification Trees</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Danny Friedman<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    <script src="../../../_static/js/index.js"></script>
    
  </body>
</html>